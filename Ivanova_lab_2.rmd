---
title: "Лабораторная работа № 2"
author: "Иванова Ксения"
date: "28 12 2020"
output: 
  word_document: 
    reference_docx: word_styles.docx
---
```{r setup, include=FALSE}
# Загрузка библиотек


library('stats') 
#library('nortest')        # для теста Андерсона-Дарлинга ad.test()
library('knitr')
library('Hmisc')          # для расчёта корреляционной матрицы
library('corrplot')       # визуализация корреляционных матриц: corrplot()

#счётчик для таблиц
table.num <- 1
#счётчик для рисунков
pic.num <- 1

knitr::opts_chunk$set(echo = TRUE)
```

##Импорт данных
Импортируем объекты, сохраненные в рабочем пространстве по итогу ЛР№1

```{r import, echo = FALSE}
load('test_lab1_Ivanova.RData')
```

```{r, echo = FALSE}
ls()

dim(reg.df)
head(reg.df)
str(reg.df)
```

# Раздел I.

## Изначальная регрессионная модель, основанная на ЛР№1

Модель 0: $Y = 89.0251 + 0.0053 \cdot X1 + 0.0976 \cdot X2 + 0.0491 \cdot X3$, где

* `Y` *PMI.2015* – Среднедушевые денежные доходы населения   
* `X1` *GRPpc.2015* – ВРП на душу населения   
* `X2` *RTT.2015* – Оборот розничной торговли на душу населения   
* `X3` *ECB.2014* – Расходы консолидированных бюджетов субъектов Российской Федерации: на социальную политику   
* `X4` *NSB.2015* – Число малых предприятий на 10000 человек населения 


##  Оценка параметров этой моделей 

#### Таблица `r table.num` - описательные статистики модели 1

```{r, echo = FALSE, warning=FALSE}
# множественная регрессия для всех регионов
fit.1 <- lm(PMI.2015 ~ GRPpc.2015 + RTT.2015 , data = reg.df)
#summary(fit.1)  # незначимые параметры

knitr::kable(round(summary(fit.1)$coef, 4))
table.num <- table.num + 1

#summary(fit.1)

par(mfrow = c(1, 2))
plot(PMI.2015 ~ GRPpc.2015 + RTT.2015, 
            data = reg.df)
reg <- lm(PMI.2015 ~ GRPpc.2015 + RTT.2015, 
            data = reg.df)
coeff = coefficients(reg)
abline(reg, col = "red")
par(mfrow = c(1, 1))

pic.num <- pic.num + 1
```

#### Рис. `r pic.num`. график разброса начальной модели

**Проверка значимости для коэффициента при GRPpc.2015.**

H0: (параметр) коэфф. при GRPpc.2015 равен 0 в генеральной совокупности (не значим);

H1: (параметр) коэфф. при GRPpc.2015 не равен 0 в генеральной совокупности (значим).

Проверим значимость при помощи p-значения.

**Напоминание:**
*Сравниваем p-значение и $\alpha$ (Уровень значимости = 0,05);*
*Если p-значение > $\alpha$, то принимается гипотеза H0, в ином случае принимается противоположная гипотеза H1.*

P-значение при GRPpc.2015 = $0.0001\cdot < \alpha$ => принимается гипотеза H1. **Параметр значим.**

**Проверка значимости для коэффициента при RTT.2015.**

H0: (параметр) коэфф. при RTT.2015 равен 0 в генеральной совокупности (не значим);

H1: (параметр) коэфф. при RTT.2015 не равен 0 в генеральной совокупности (значим).

Проверим значимость при помощи p-значения.

P-значение при RTT.2015 = $0.000\cdot < \alpha$ => принимается гипотеза H1. **Параметр значим.**


## Пошаговое исключение регрессоров

Исключаем ECB.2014  p-значение > 0.05 (0.1467)

Явный вид модели 1: $Y = 6624.4537 + 0.005 \cdot X1 + 0.11496 \cdot X2$


#### Рис. `r pic.num`. график разброса исправленной модели

## модель с переменной структурой по федеральным округам 
Построим модель с переменной структурой, используя принадлежность каждого региона к одному из восьми федеральных округов.
Включим фиктивные переменные как в константу, так и в коэффициенты.
Общий вид модели с переменной структурой.

#### Таблица `r table.num` - описательные статистики модели по федеральным округам

```{r, echo = FALSE}
fit.1.fo <- lm(PMI.2015 ~ (GRPpc.2015 + RTT.2015) * FO, data = reg.df)
kable(round(summary(fit.1.fo)$coef, 4))
table.num <- table.num + 1
#summary(fit.1.fo)
```

Модель в целом незначима, но скорректированный коэффициент
детерминации у неё намного выше, чем у модели по всем регионам (`r round(summary(fit.1.fo)$r.sq, 3)*100`%). У неё несколько незначимых параметров.
Исключать их последовательно вручную трудоёмко, поэтому мы воспользуемся пользовательской функцией, которая
проводит процедуру последовательного исключения регрессоров.

Сначала сгенерируем матрицу независимых переменных функцией
*model.matrix()*. После загружаем функцию для исключения незначимых регрессоров
из файла «removeFactorsByPValue.R» в рабочей директории и применяем её
к модели с переменной структурой.

### Модель без поправки:

#### Таблица `r table.num` - описательные статистики модели по федеральным округам без поправки

```{r, echo = FALSE}
# создаём фрейм со всеми переменными-факторами (создаём фиктивные)
X.matrix <- model.matrix(PMI.2015 ~ FO * (GRPpc.2015 + RTT.2015) , data = reg.df)

# присоединяем независимую переменную
data.fit <- cbind(PMI.2015 = reg.df$PMI.2015, 
                  data.frame(X.matrix)[, -1])

# результат
head(data.fit)
tail(data.fit)

# сохраняем для следующей лабораторной
data.fit.1.fo <- data.fit

source('https://raw.githubusercontent.com/aksyuk/R-Practice-basics/master/user_functions/removeFactorsByPValue.R')

# применяем процедуру, сначала без поправок на p-значения
fit.1.fo <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'PMI.2015')
kable(round(summary(fit.1.fo)$coef, 4))
table.num <- table.num + 1
#summary(fit.1.fo)
```

Все коэффициенты модели значимы, но уровень коэффициента детерминации немого погизился. ($R^2 =$ `r round(summary(fit.1.fo)$r.sq, 3)`)

Значима константа для Приволжского, Северо-Кавказского, Северного, Уральскго, Центрального и Южного федеральных
округов, а также коэффициент при независимых переменных для некоторых округов. 

*(GRPpc.2015 с константой Северно-западного, Уральского и Южного федеральных округов; RTT.2015 с константой Приволжского, Северо-Кавказского, Северного, Уральского и У=Центрального федеральных округов )*
   

Явный вид модели 2: $PMI.2015 = 35711.4297 -32589.7279 \cdot FOПФО - 25003.337 \cdot FOСКФО - 28303.33 \cdot FOСФО - 26009.2588 \cdot FOУФО	- 32036.3410 \cdot FOЦФО - 34357.8113 \cdot FOЮФО + 0.0187 \cdot GRPpc.2015 - 0.0461 \cdot RTT.2015 - 0.0178 \cdot FOСЗФО.GRPpc.2015 - 0.0074 \cdot FOУФО.GRPpc.2015 + 0.0877 \cdot FOЮФО.GRPpc.2015 + 0.1499 \cdot FOПФО.RTT.2015 + 0.1032 \cdot FOСКФО.RTT.2015 + 0.1160 \cdot FOСФО.RTT.2015 + 0.1156 \cdot FOУФО.RTT.2015 + 0.1464 \cdot FOЦФО.RTT.2015$


### Модель с поправкой Бонферрони:


#### Таблица `r table.num` - описательные статистики модели по федеральным округам с поправкой Бонферрони

```{r, echo = FALSE}
# теперь с поправкой Бонферрони
fit.1.foB <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'PMI.2015',
                                   p.adj.method = 'bonferroni')
kable(round(summary(fit.1.fo)$coef, 4))
table.num <- table.num + 1
#summary(fit.1.fo)
```
Коэффициенты модели при *PIM.2013* значимы, однако коэффициент детерминации не изменился ($R^2 =$ `r round(summary(fit.1.fo)$r.sq, 3)`).



# строим ПЛР на второй по силе корреляции фактор

Построим модель с переменной структурой, используя принадлежность каждого региона к одному из восьми федеральных округов.
Включим фиктивные переменные как в константу, так и в коэффициенты.
Общий вид модели с переменной структурой.


```{r, echo = FALSE}
# строим ПЛР на второй по силе корреляции фактор
fit.2 <- lm(PMI.2015 ~ ECB.2014, 
             data = reg.df)
#summary(fit.2)
```

Модель со 2 фактором по силе корреляции не значима, и имеет очень слабый коэффицент детерминации ($R^2 =$ `r round(summary(fit.2)$r.sq, 3)`)

#### Таблица `r table.num` - описательные статистики модели по федеральным округам

```{r, echo = FALSE}
# модель с переменной структурой
fit.2.fo <- lm(PMI.2015 ~ FO *  ECB.2014, 
                data = reg.df)
kable(round(summary(fit.2.fo)$coef, 4))
table.num <- table.num + 1
#summary(fit.2.fo)
```

Модель в целом незначима, но скорректированный коэффициент
детерминации у неё ниже, чем у модели по всем регионам (`r round(summary(fit.1.fo)$r.sq, 3)*100`%). У неё нет незначимых параметров.

Явый вид модели 3: $PMI.2015 = 47095.462 - 29899.9186 \cdot FOПФО - 21965.91 \cdot FOСЗФО - 29889.264 \cdot FOСКФО - 27527.988 \cdot FOСФО - 18904.3916 \cdot FOУФО	- 22639.8867 \cdot FOЦФО - 31064.8028 \cdot FOЮФО - 0.8248 \cdot ECB.2014  + 1.3396 \cdot FOПФО:ECB.2014 + 1.1530 \cdot FOСЗФО:ECB.2014 + 1.3262 \cdot FOСКФО:ECB.2014 + 1.0679 \cdot FOСФО:ECB.2014 + 1.2752 \cdot FOУФО:ECB.2014 + 0.9803 \cdot FOЦФО:ECB.2014 + 1.2993 \cdot FOЮФО:ECB.2014$



 ## Сравнение моделей по качеству.

Сравним три полученные модели: изначальную, с поправкой по ФО и без поправки по ФО.


 #### Таблица `r table.num` - сравнение трёх моделей
```{r, echo = FALSE}
# модели с фактором PIM.2013
#anova(fit.1, fit.1.foB, fit.2.fo)

# список построенных моделей
models.list <- list(fit.1, fit.1.foB, fit.2.fo)
names(models.list) <- c('fit.1', 'fit.1.foBonferroni', 'fit.2.fo')
# фрейм с характеристиками четырёх моделей
df.goodness.of.fit <- data.frame(Модель = names(models.list), 
                                       R.2.скорр = 0,
                                       F.расч = 0,
                                       Станд.Ошибка = 0)
for (i in 1:length(models.list)) {
  # скорректированный R-квадрат
  df.goodness.of.fit[i, 'R.2.скорр'] <- 
    round(summary(models.list[[i]])$adj.r.squared, 3)
  # F расчётное
  df.goodness.of.fit[i, 'F.расч'] <- 
    round(summary(models.list[[i]])$fstatistic[1], 2)
  # стандартная ошибка
  df.goodness.of.fit[i, 'Станд.Ошибка'] <- 
    round(summary(models.list[[i]])$sigma, 1)
}
kable(df.goodness.of.fit)
table.num <- table.num + 1
#mean(reg.df$PMI.2015)

```
Результат: 

Среднее по Y = 27653.7;

По столбцу $R^2$ больше всего подходит третья модель;
По столбцу F.расч - первая;
По минимальной Стандартной ошибке третья.

Таким образом, модель по федеральным округам без поправки (fit.2.fo) наиболее предпочтительна.

Явный вид модели 4: $PMI.2015 = 47095.462 - 29899.9186 \cdot FOПФО - 21965.91 \cdot FOСЗФО - 29889.264 \cdot FOСКФО - 27527.988 \cdot FOСФО - 18904.3916 \cdot FOУФО	- 22639.8867 \cdot FOЦФО - 31064.8028 \cdot FOЮФО - 0.8248 \cdot ECB.2014  + 1.3396 \cdot FOПФО:ECB.2014 + 1.1530 \cdot FOСЗФО:ECB.2014 + 1.3262 \cdot FOСКФО:ECB.2014 + 1.0679 \cdot FOСФО:ECB.2014 + 1.2752 \cdot FOУФО:ECB.2014 + 0.9803 \cdot FOЦФО:ECB.2014 + 1.2993 \cdot FOЮФО:ECB.2014$



 # Раздел II

 ## Изначаьная регрессионная модель для логарифмированных данных, основанная на ЛР№1

Модель 0: $Y =  2.8097 + 0.2515	\cdot X1 + 0.3233\cdot X2 + 0.0327	\cdot X3$, где

* `Y` *PMI.2015* – Индексы промышленного производства.  

* `X1` *PIM.2013* – Индесы цен производителей промышленных товаров по видам экономической деятельности: обрабатывающие производства.

* `X2` *DDFA.2013* – Степень износа основных фондов.   

* `X3` *FCI.2012* – Инвестиции в основвной капитал на душу населения.   

* `X4` *DLR.2013* – Задолжность по кредитам в рублях, предоставленым кредитными организациями юридическим лицам.

По количеству `r nrow(DF1)`-x наблюдений.

```{r, echo = FALSE, warning=FALSE}
# множественная регрессия для всех регионов на логарифмированных данных
fit.11 <- lm(PMI.2015 ~ GRPpc.2015 + RTT.2015 , 
            data = DF1)
#summary(fit.11)
kable(round(summary(fit.11)$coef, 4))  # незначимые параметры
table.num <- table.num + 1
#построим график
par(mfrow = c(1, 2))
plot(PMI.2015 ~ GRPpc.2015 + RTT.2015  , 
            data = DF1)
reg <- lm(PMI.2015 ~ GRPpc.2015 + RTT.2015 , 
            data = DF1)
coeff = coefficients(reg)
abline(reg, col = "red")

par(mfrow = c(1, 1))
pic.num <- pic.num + 1
```
#### Рис. `r pic.num`. график разброса начальной логарифмированной модели

## Проверка значимости для логарифмированных значений:

**Проверка значимости для коэффициента при GRPpc.2015.**

H0: (параметр) коэфф. при GRPpc.2015 равен 0 в генеральной совокупности (не значим);

H1: (параметр) коэфф. при GRPpc.2015 не равен 0 в генеральной совокупности (значим).

Проверим значимость при помощи p-значения. ( $\alpha = 0,05$ )

P-значение при GRPpc.2015 = $0 < \alpha$ => принимается гипотеза H1. **Параметр значим.**

**Проверка значимости для коэффициента при RTT.2015.**

H0: (параметр) коэфф. при RTT.2015 равен 0 в генеральной совокупности (не значим);

H1: (параметр) коэфф. при RTT.2015 не равен 0 в генеральной совокупности (значим).

Проверим значимость при помощи p-значения. ( $\alpha = 0,05$ )

P-значение при RTT.2015 = $0 < \alpha$ => принимается гипотеза H1. **Параметр значим.**

Явный вид модели 1: $Y =  2.4719 + 0.2466	\cdot X1 + 0.3816\cdot X2$

# Модель с переменной структурой по федеральным округам (логарифмированные данные).

Построим модель с переменной структурой, используя принадлежность каждого региона к одному из восьми федеральных округов.
Включим фиктивные переменные как в константу, так и в коэффициенты.
Общий вид модели с переменной структурой.

#### Таблица `r table.num` - описательные статистики логарифмированной модели по федеральным округам
```{r, echo = FALSE}
fit.11.fo <- lm(PMI.2015 ~ FO*(GRPpc.2015 + RTT.2015), 
            data = DF1)
#summary(fit.11.fo)
kable(round(summary(fit.11.fo)$coef, 4))
table.num <- table.num + 1
```

Модель в целом незначима, но скорректированный коэффициент
детерминации у неё выше, чем у модели по всем регионам (`r round(summary(fit.11.fo)$r.sq, 3)*100`%). У неё несколько незначимых параметров.
Исключать их последовательно вручную трудоёмко, поэтому мы воспользуемся пользовательской функцией, которая
проводит процедуру последовательного исключения регрессоров.

Сначала сгенерируем матрицу независимых переменных функцией
*model.matrix()*. После загружаем функцию для исключения незначимых регрессоров
из файла «removeFactorsByPValue.R» в рабочей директории и применяем её
к модели с переменной структурой.

### Модель без поправки:




#### Таблица `r table.num` - описательные статистики логарифмированной модели по федеральным округам без поправки

```{r, echo = FALSE}
# создаём фрейм со всеми переменными-факторами (создаём фиктивные)
X.matrix <- model.matrix(PMI.2015 ~ FO*(GRPpc.2015 + RTT.2015), 
            data = DF1)
# присоединяем независимую переменную
data.fit <- cbind(PMI.2015 = DF1$PMI.2015, 
                  data.frame(X.matrix)[, -1])

# сохраняем для следующей лабораторной
data.fit.11.fo <- data.fit

# функция с последовательным исключением незначимых регрессоров
source('https://raw.githubusercontent.com/aksyuk/R-Practice-basics/master/user_functions/removeFactorsByPValue.R')

# применяем процедуру, сначала без поправок на p-значения
fit.11.fo <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'PMI.2015')
kable(round(summary(fit.11.fo)$coef, 4))
table.num <- table.num + 1
summary(fit.11.fo)
```
Все коэффициенты модели значимы и она имеет сильный уровень коэффициента детерминации. $R^2 =$ `r round(summary(fit.11.fo)$r.sq, 3)`.

Значимы константы для Приволжского, Северо-Западного, Уральского, Центрального и Южного федеральных округов

*(GRPpc.2015 с Северо-Западным, Северо-Кавказским, Северным и Южным федеральных округов; RTT.2015 с приволжским, Северо-Кавказским, Северным и Центральным)*

Явный вид модели 2: $PMI.2015 = 5.5031 - 6.1709 \cdot FOПФО + 4.4903 \cdot FOСЗФО - 0.1943 \cdot FOУФО - 5.0777 \cdot FOЦФО - 7.4554 \cdot FOЮФО + 0.3806 \cdot GRPpc.2015  - 0.3609 \cdot FOСЗФО.GRPpc.2015 - 0.4024 \cdot FOСКФО.GRPpc.2015 + 0.5773 \cdot FOЮФО.GRPpc.2015 + 0.5009 \cdot FOПФО.RTT.2015 + 0.4023 \cdot FOСКФО.RTT.2015 + 0.2830 \cdot FOСФО.RTT.2015 + 0.4114 \cdot FOЦФО.RTT.2015$

### Модель с поправкой Бонферрони:

Явный вид модели 3: $PMI.2015 = 5.9135 - 6.5239 \cdot FOПФО - 5.6774 \cdot FOЦФО - 7.8658 \cdot FOЮФО + 0.3499 \cdot GRPpc.2015  - 0.3414 \cdot FOСЗФО.GRPpc.2015 - 0.4164 \cdot FOСКФО.GRPpc.2015 - 0.024 \cdot FOСФО.GRPpc.2015 + 0.6080 \cdot FOЮФО.GRPpc.2015 + 0.5286 \cdot FOПФО.RTT.2015 + 0.3502 \cdot FOСЗФО.RTT.2015 + 0.4130 \cdot FOСКФО.RTT.2015 -  \cdot FOУФО.RTT.2015 + 0.4593 \cdot FOЦФО.RTT.2015$.


#### Таблица `r table.num` - описательные статистики логарифмированной модели по федеральным округам с поправкой Бонферрони
```{r, echo = FALSE}
# теперь с поправкой Бонферрони
fit.11.foB <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'PMI.2015',
                                   p.adj.method = 'bonferroni')
#summary(fit.11.foB)
kable(round(summary(fit.11.foB)$coef, 4))
table.num <- table.num + 1
```
Коэффициент модели при *PMI.2015* значим, однако коэффициент детерминации немного понизился ($R^2 =$ `r round(summary(fit.11.foB)$r.sq, 3)`).

Сравним три полученные модели: изначальную, с поправкой по ФО и без поправки по ФО.


#### Таблица `r table.num` - сравнение трёх моделей
```{r, echo = FALSE}
# модели с фактором PIM.2013
#anova(fit.11, fit.11.foB, fit.11.fo)

# список построенных моделей
models.list <- list(fit.11, fit.11.foB, fit.11.fo)
names(models.list) <- c('fit.11', 'fit.11.foBonferroni', 'fit.11.fo')

# фрейм с характеристиками четырёх моделей
df.goodness.of.fit <- data.frame(Модель = names(models.list), 
                                       R.2.скорр = 0,
                                       F.расч = 0,
                                       Станд.Ошибка = 0)
for (i in 1:length(models.list)) {
  # скорректированный R-квадрат
  df.goodness.of.fit[i, 'R.2.скорр'] <- 
    round(summary(models.list[[i]])$adj.r.squared, 3)
  # F расчётное
  df.goodness.of.fit[i, 'F.расч'] <- 
    round(summary(models.list[[i]])$fstatistic[1], 2)
  # стандартная ошибка
  df.goodness.of.fit[i, 'Станд.Ошибка'] <- 
    round(summary(models.list[[i]])$sigma, 1)
}
kable(df.goodness.of.fit)
table.num <- table.num + 1
#mean(DF1$PMI.2015)

```
Результат: 

Среднее по Y = 10.17856;

По столбцу $R^2$ больше всего подходит третья;
По столбцу F.расч - первая;
По минимальной Стандартной ошибке - вторая и третья

Выберем третью модель.

Явный вид модели: $PMI.2015 = 5.5031 - 6.1709 \cdot FOПФО + 4.4903 \cdot FOСЗФО - 0.1943 \cdot FOУФО - 5.0777 \cdot FOЦФО - 7.4554 \cdot FOЮФО + 0.3806 \cdot GRPpc.2015  - 0.3609 \cdot FOСЗФО.GRPpc.2015 - 0.4024 \cdot FOСКФО.GRPpc.2015 + 0.5773 \cdot FOЮФО.GRPpc.2015 + 0.5009 \cdot FOПФО.RTT.2015 + 0.4023 \cdot FOСКФО.RTT.2015 + 0.2830 \cdot FOСФО.RTT.2015 + 0.4114 \cdot FOЦФО.RTT.2015$
 
 
 	

```{r, echo = FALSE}
# 4. Сохранение нужных объектов рабочего пространства  -------------------------
save(list = c('data.fit.1.fo', 'data.fit.11.fo', 'fit.1.fo', 'fit.11.fo', 'DF', 'DF1', 'reg.df'), 
    file = 'test_lab2_Ivanovba.RData')
```